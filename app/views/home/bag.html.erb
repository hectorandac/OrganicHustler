
<% tax_array = [] %>
<% cost_array = [] %>

<div class="desktopnot" style="margin-top: -50px"></div>
<div class="mobilenot" style="margin-top: 50px"></div>
<div style="overflow: hidden; margin: 0 7%;">
<div class="content-part field-data">

  <% CartProduct.where(cart_id: get_cart_id).each do |product| %>
      <% product_temp = get_product(product.m_id) %>
      <div class="item-checkout" style="margin-bottom: 20px">
        <div style="float: left; width: 33%; position: relative">
          <div id="<%= product.id %>cart" style="width: 100%; height: 100%; margin-left: auto; margin-right: auto;"></div>
        </div>
        <div style="float: left; width: 67%; position: relative">
          <h4><%= product_temp['title'] %></h4>
          <div style="float: left; width: 50%">
            <h6>Size: <%= get_variation(product_temp, 'Size', product.size_id)['title'] %></h6> <!--FIX MISSING ATRIBUTES-->
            <h6>Customized:
              <% if product.has_emblem %>YES
              <% elsif product.has_logo %>YES
              <% else %>NO
              <% end %></h6>
            <h6>Color: BROWN</h6> <!-- Attach to backend -->
          </div>
          <div style="float: left; width: 50%; text-align: center">
            <h3>Qty: 1</h3> <!-- Attach to backend -->
            <% pr_price = product_price(product.id) %>
            <h4><%= pr_price[5] %></h4>
            <% tax_array.push(pr_price[1]) %>
            <% cost_array.push(pr_price[5]) %>
          </div>
        </div>
      </div>

      <script id="create-shape">
          createShape('<%= product.id %>cart', '<%= product.width %>', '<%= product.height %>', '<%= product.dim_x %>', '<%= product.dim_y %>', '<%= product.relation_x %>', '<%= product.relation_y %>')
          function createShape(id, width, height, x, y, s_w, s_h) {
              var container = $('#' + id);
              container.height(container.width());

              var stage = new Konva.Stage({
                  container: id,
                  width: container.width(),
                  height: container.height()
              });
              var layer = new Konva.Layer();
              stage.add(layer);

              var baseImg = new Konva.Image({
                  width: container.width(),
                  height: container.height(),
                  draggable: false
              });

              var logoImg = new Konva.Image({
                  width: container.width() * width / s_w,
                  height: container.height() * height / s_h
              });

              var logoGroup = new Konva.Group({
                  x: container.width() * x / s_w,
                  y: container.width() * y / s_h
              });

              layer.add(baseImg);
              layer.add(logoGroup);
              logoGroup.add(logoImg);

              var imageObj1 = new Image();
              imageObj1.onload = function () {
                  baseImg.image(imageObj1);
                  layer.draw();
              };
              imageObj1.src = '<%= product_temp['images'].first['url']['https'] %>';

              var imageObj2 = new Image();
              imageObj2.onload = function () {
                  logoImg.image(imageObj2);
                  layer.draw();
                  imageObj2.width = container.width() * width / s_w;
                  console.log(imageObj2.width, container.width(), width, s_w);
                  imageObj2.height = container.height() * height / s_h;
                  console.log(imageObj2.height);
              };
              imageObj2.src = '<%= get_thumb_g_id(product.logo_id, :thumb) %>';
              layer.draw();
          }
      </script>

  <% end %>

</div>
</div>